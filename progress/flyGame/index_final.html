<!DOCTYPE html>
<html>
<head>
    <title>飞机大战HTML5版本</title>
    <meta charset="utf-8" />
</head>

<body>
<!-- <div>元素 - 完成布局 -->
<div style="margin:0 auto;width:480px; height:650px;background:#323232; text-align:center;vertical-align:middle">
    <!-- <canvas>元素 -->
    <canvas id="canvas" width="480px" height="650px"></canvas>
</div>
<script>
    /*
     * javascript的高级内容
     * * 特殊函数
     *   * 匿名函数
     *   * 回调函数
     *   * 自调函数
     *   * 内部函数
     * * 闭包
     * * 对象(直接量或构造器)
     * * 原型
     * * 继承
     */

    /*
     * 使用JS的面向对象(构造器)
     * * 创建全局对象Game
     *   * 游戏的背景
     *   * 游戏的过渡动画
     *   * 我方飞机
     *   * 子弹
     *   * 敌方飞机
     */

    // 使用<canvas>固定2步
    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");
    /*
     * 全局变量或全局函数的问题
     * * 存储在浏览器的内存中
     *   * 全局变量或函数越多,占内存越多,性能越差
     * * 不使用全局变量或全局函数的方式
     *   * 使用局部变量或内部函数
     *   * 使用对象的属性或方法
     */
    // 1 完成游戏的初始化
    const START = 0;
    const STARTTING = 1;
    const RUNNING = 2;
    const PAUSED = 3;
    const GAMEOVER = 4;

    var state = START;

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    var life = 3;
    var score = 0;

    // 2 加载游戏所需的所有图片
    var bg = new Image();
    bg.src = "images/background.png";
    var logo = new Image();
    logo.src = "images/start.png";

    canvas.onclick = function(){
        // 保证游戏当前是第一阶段
        if(state == START){
            state = STARTTING;
        }
    }

    var loadings = [];
    loadings[0] = new Image();
    loadings[0].src = "images/game_loading1.png";
    loadings[1] = new Image();
    loadings[1].src = "images/game_loading2.png";
    loadings[2] = new Image();
    loadings[2].src = "images/game_loading3.png";
    loadings[3] = new Image();
    loadings[3].src = "images/game_loading4.png";

    var heros = [];
    heros[0] = new Image();
    heros[0].src = "images/hero1.png";
    heros[1] = new Image();
    heros[1].src = "images/hero2.png";
    // 增加我方飞机爆破动画的图片
    heros[2] = new Image();
    heros[2].src = "images/hero_blowup_n1.png";
    heros[3] = new Image();
    heros[3].src = "images/hero_blowup_n2.png";
    heros[4] = new Image();
    heros[4].src = "images/hero_blowup_n3.png";
    heros[5] = new Image();
    heros[5].src = "images/hero_blowup_n4.png";
    var bullet = [];
    bullet[0] = new Image();
    bullet[0].src = "images/bullet.png";
    var enemies1 = [];//小飞机
    enemies1[0] = new Image();
    enemies1[0].src = "images/enemy1.png";
    // 小飞机爆破动画的图片
    enemies1[1] = new Image();
    enemies1[1].src = "images/enemy1_down1.png";
    enemies1[2] = new Image();
    enemies1[2].src = "images/enemy1_down2.png";
    enemies1[3] = new Image();
    enemies1[3].src = "images/enemy1_down3.png";
    enemies1[4] = new Image();
    enemies1[4].src = "images/enemy1_down4.png";
    var enemies2 = [];//中飞机
    enemies2[0] = new Image();
    enemies2[0].src = "images/enemy2.png";
    // 中飞机爆破动画的图片
    enemies2[1] = new Image();
    enemies2[1].src = "images/enemy2_down1.png";
    enemies2[2] = new Image();
    enemies2[2].src = "images/enemy2_down2.png";
    enemies2[3] = new Image();
    enemies2[3].src = "images/enemy2_down3.png";
    enemies2[4] = new Image();
    enemies2[4].src = "images/enemy2_down4.png";
    var enemies3 = [];//大飞机
    enemies3[0] = new Image();
    enemies3[0].src = "images/enemy3_n1.png";
    enemies3[1] = new Image();
    enemies3[1].src = "images/enemy3_n2.png";
    // 大飞机爆破动画的图片
    enemies3[2] = new Image();
    enemies3[2].src = "images/enemy3_down1.png";
    enemies3[3] = new Image();
    enemies3[3].src = "images/enemy3_down2.png";
    enemies3[4] = new Image();
    enemies3[4].src = "images/enemy3_down3.png";
    enemies3[5] = new Image();
    enemies3[5].src = "images/enemy3_down4.png";
    enemies3[6] = new Image();
    enemies3[6].src = "images/enemy3_down5.png";
    enemies3[7] = new Image();
    enemies3[7].src = "images/enemy3_down6.png";

    var paused = new Image();
    paused.src = "images/game_pause_nor.png";

    // 3 初始化游戏的相关数据
    var SKY = {
        imgs : bg,//背景图片
        width : 480,
        height : 852
    }
    var LOADING = {
        imgs : loadings,
        width : 186,
        height : 38,
        sum : loadings.length
    }
    var HERO = {
        imgs : heros,
        width : 99,
        height : 124,
        sum : heros.length,
        length : 2
    }
    var BULLET = {
        imgs : bullet,
        width : 9,
        height : 21
    }
    var ENEMY1 = {
        imgs : enemies1,
        width : 57,
        height : 51,
        sum : enemies1.length,
        length : 1,
        type : 0, //敌方飞机的类型
        life : 1,  //敌方飞机的生命值
        score : 1
    }
    var ENEMY2 = {
        imgs : enemies2,
        width : 69,
        height : 95,
        sum : enemies2.length,
        length : 1,
        type : 1, //敌方飞机的类型
        life : 3,  //敌方飞机的生命值
        score : 5
    }
    var ENEMY3 = {
        imgs : enemies3,
        width : 169,
        height : 258,
        sum : enemies3.length,
        length : 2,
        type : 2, //敌方飞机的类型
        life : 10, //敌方飞机的生命值
        score : 10
    }
    /*
     * 1. 游戏初始化无法优化
     * 2和3. 来源于服务器端的数据内容
     *      * 前端代码尽量地使用通用代码
     *      * 可能改变的数据内容,来源于服务器端
     */

    // 4 创建构造器
    function Compant(config){
        // 加载图片
        this.imgs = config.imgs;
        // 图片的宽度和高度
        this.width = config.width;
        this.height = config.height;
        this.sum = config.sum;
        this.length = config.length;
        // 敌方飞机具有以下属性
        this.type = config.type;
        this.life = config.life;
        this.score = config.score;
        // 设置相对速度
        this.time = 0;
        // 设置图片的索引值
        this.index = 0;
        // 是否执行爆破动画的标识
        this.down = false;
        // 是否删除标识
        this.canDelete = false;

        this.x = 0;
        this.y = 0;

        // 绘制方法
        this.paint = function(){
            context.drawImage(this.imgs[this.index],this.x,this.y);
        }
        // 移动方法
        this.step = function(){}
        // 执行撞击后的逻辑方法
        this.bang = function(){}
    }

    function Sky(config){
        Compant.call(this,config);

        // 定义绘制的第一张图片的y值
        this.y1 = -this.height;
        // 定义绘制的第二张图片的y值
        this.y2 = 0;

        // 定义绘制方法
        this.paint = function(){
            context.drawImage(this.imgs,0,this.y1);// 第一张
            context.drawImage(this.imgs,0,this.y2);// 第二张
        }
        // 定义移动方法
        this.step = function(){
            this.time++;
            if(this.time%5==0){
                // 两张图片向下移动 - y++
                this.y1++;
                this.y2++;
            }
            // 判断两张图片是否移出画面
            if(this.y1 > HEIGHT){
                this.y1 = -this.height;
            }
            if(this.y2 > HEIGHT){
                this.y2 = -this.height;
            }
        }
    }
    function Loading(config){
        Compant.call(this,config);

        this.x = 0;
        this.y = HEIGHT-this.height;

        // 定义动画方法
        this.step = function(){
            this.time++;
            if(this.time%20==0){
                // 切换数组的角标
                this.index++;
            }
            // 判断this.index == 4,游戏进入到第三阶段
            if(this.index == this.sum){
                // 游戏进入到第三阶段
                state = RUNNING;
            }
        }
    }
    function Hero(config){
        Compant.call(this,config);

        // 定义绘制我方飞机的坐标值
        this.x = (WIDTH-this.width)/2;
        this.y = HEIGHT-this.height-30;

        // 定义动画方法
        this.step = function(){
            if(this.down){
                // 爆破动画图片的切换
                this.index++;
                // 当爆破动画执行完毕后
                if(this.index == this.sum){
                    // 判断生命值是否为0
                    if(life > 0){
                        // 重新创建我方飞机
                        hero = new Hero(HERO);
                    }else{
                        // 生命值=0,结束游戏
                        state = GAMEOVER;
                    }
                    this.index = this.sum-1;
                }
            }else{
                // 0 1 2(0)
                this.index++;
                this.index = this.index%2;
            }
        }

        // 增加我方飞机的射击方法
        this.shoot = function(){
            this.time++;
            if(this.time%20==0){
                // 创建子弹对象,并且添加到数组中
                var bullet = new Bullet(BULLET);
                bullets[bullets.length] = bullet;
            }
        }

        // 增加我方飞机被撞击后的逻辑
        this.bang = function(){
            // 我方飞机的生命值-1
            life--;
            // 我方飞机执行爆破动画
            this.down = true;
            // 将数组的角标切换的爆破动画的第一张
            this.index = this.length;
        }
    }
    function Bullet(config){
        Compant.call(this,config);

        // 定义子弹的坐标值
        this.x = hero.x + hero.width/2 - this.width/2;
        this.y = hero.y - this.height - 10;

        // 定义移动子弹的方法
        this.step = function(){
            this.y -= 2;
        }

        // 定义子弹被撞击后的逻辑
        this.bang = function(){
            this.canDelete = true;
        }
    }
    function Enemy(config){
        Compant.call(this,config);

        // 定义绘制敌方飞机的坐标值
        this.x = Math.random() * (WIDTH - this.width);
        this.y = -this.height;

        // 定义移动方法
        this.step = function(){
            // 判断this.down的值
            if(this.down){//执行爆破动画
                this.time++;
                if(this.time%5==0){
                    // 切换爆破动画的图片角标++
                    this.index++;
                }

                // 判断爆破动画是否执行完毕
                if(this.index == this.sum){
                    // 爆破动画执行完毕,删除敌方飞机
                    this.canDelete = true;
                    // 解决错误,重新设置index值
                    this.index = this.sum-1;
                    // 累加游戏的得分
                    score += this.score;
                }
            }else{//正常情况
                // 敌方飞机自上向下移动
                this.time++;
                switch (this.type){
                    case 0://小飞机
                        this.y++;
                        break;
                    case 1://中飞机
                        if(this.time%2==0){
                            this.y++;
                        }
                        break;
                    case 2://大飞机
                        this.index++;
                        this.index = this.index%2;
                        if(this.time%5==0){
                            this.y++;
                        }
                        break;
                }
            }
        }

        // 增加敌方飞机是否被撞击的判断规则方法
        this.hit = function(compant){
            //子弹|我方飞机 - 定义形参
            //返回值为true,表示被撞击
            return compant.x + compant.width > this.x &&
                    compant.y < this.y + this.height &&
                    compant.x < this.x + this.width &&
                    compant.y + hero.height > this.y;
        }
        // 定义敌方飞机被撞击后的方法
        this.bang = function(){
            // 敌方飞机的生命值-1
            this.life--;
            // 判断敌方飞机的生命值如果等于0,执行爆破动画
            if(this.life == 0){
                // 执行爆破动画
                this.down = true;
                /*
                 * 操作this.index的值
                 * * 小、中飞机 - index从1开始
                 * * 大飞机 - index从2开始
                 */
                this.index = this.length;
            }
        }
    }

    // 5 创建所有构造器的对象
    var sky = new Sky(SKY);
    var loading = new Loading(LOADING);
    var hero = new Hero(HERO);
    var bullets = [];
    var enemies = [];

    // 6 用于操作对象的函数
    function paintBullets(){
        for(var i=0;i<bullets.length;i++){
            bullets[i].paint();
        }
    }
    function Bullets(){
        for(var i=0;i<bullets.length;i++){
            bullets[i].step();
            if(bullets[i].y <= -bullets[i].height || bullets[i].canDelete){
                bullets.splice(i,1);
            }
        }
    }
    function createEmeies(){
        var num = Math.floor(Math.random()*100);
        if(num <= 80){// 小飞机
            var enemy = new Enemy(ENEMY1);
            enemies[enemies.length] = enemy;
        }else if(num < 90){//中飞机
            var enemy = new Enemy(ENEMY2);
            enemies[enemies.length] = enemy;
        }else{
            if(enemies.length > 0 && enemies[0].type != 2){//创建大飞机
                var enemy = new Enemy(ENEMY3);
                enemies.splice(0,0,enemy);
            }
        }
    }
    function paintEnemies(){
        for(var i=0;i<enemies.length;i++){
            enemies[i].paint();
        }
    }
    function Enemies(){
        for(var i=0;i<enemies.length;i++){
            enemies[i].step();
            if(enemies[i].y > HEIGHT || enemies[i].canDelete){
                enemies.splice(i,1);
            }
        }
    }

    // 6 其他函数
    function checkHit(){
        // a. 遍历存储敌方飞机的数组
        for(var i=0;i<enemies.length;i++){
            // b. 获取每个敌方飞机
            var enemy = enemies[i];
            // c. 判断我方飞机是否撞击敌方飞机
            if(enemy.hit(hero)){
                // 判断bang()方法是否执行
                if(!enemy.down && !hero.down){
                    // 处理敌方飞机被撞击后的逻辑
                    enemy.bang();
                    // 处理我方飞机被撞击后的逻辑
                    hero.bang();
                }
            }
            /*
             * d. 判断子弹是否撞击敌方飞机
             *  * 遍历所有的子弹(存储子弹的数组)
             *  * 判断每个子弹是否撞击敌方飞机
             */
            for(var j=0;j<bullets.length;j++){
                // 获取每个子弹
                var bullet = bullets[j];
                if(enemy.hit(bullet)){
                    if(!enemy.down&&!bullet.canDelete){
                        // 处理敌方飞机被撞击后的逻辑
                        enemy.bang();
                        // 处理子弹被撞击后的逻辑
                        bullet.bang();
                    }
                }
            }
        }
    }
    function paintText(){
        context.font = "bold 24px 微软雅黑";
        context.fillText("SCORE: "+score,10,30);
        context.fillText("LIFE: "+life,400,30);
    }
    function gameOver(){
        context.font = "bold 48px 微软雅黑";
        context.fillText("GAME OVER",WIDTH/2-150,HEIGHT/2);
    }

    // 7 canvas的事件
    canvas.onmouseover = function(){
        if(state == PAUSED){
            state = RUNNING;
        }
    }
    canvas.onmouseout = function(){
        if(state == RUNNING){
            state = PAUSED;
        }
    }
    canvas.onmousemove = function(event){
        if(state == RUNNING){
            // a. 获取鼠标的当前坐标值(x,y)
            var x = event.offsetX;
            var y = event.offsetY;
            // b. 将鼠标的当前坐标值,赋值给我方飞机的坐标值
            hero.x = x-hero.width/2;
            hero.y = y-hero.height/2;
        }
    }

    var time = 0;
    setInterval(function(){
        sky.paint();//绘制背景图片
        sky.step();//移动背景图片
        switch (state){
            case START:
                context.drawImage(logo,20,0);//绘制LOGO

                break;
            case STARTTING:
                loading.paint();//绘制动画图片
                loading.step();//切换动画图片
                break;
            case RUNNING:
                hero.paint();//绘制我方飞机
                hero.step();//控制我方飞机动画
                hero.shoot();//我方飞机的射击功能
                paintBullets();//绘制所有子弹
                stepBullets();//移动所有子弹
                delBullets();//移出子弹
                time++;
                if(time%50==0){
                    createEmeies();//创建敌方飞机
                }
                paintEnemies();//绘制敌方飞机
                stepEnemies();//移动敌方飞机
                delEnemies();
                checkHit();//判断敌方飞机是否被撞击
                paintText();//绘制得分和生命值
                break;
            case PAUSED:
                hero.paint();
                paintBullets();
                paintEnemies();
                paintText();
                context.drawImage(paused,WIDTH/2-30,HEIGHT/2-22.5);
                break;
            case GAMEOVER:
                hero.paint();
                paintBullets();
                paintEnemies();
                paintText();
                gameOver();
                break;
        }
    },10);
</script>
</body>
</html>